<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using MAST with RNASeq: MAIT Analysis. • MAST</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using MAST with RNASeq: MAIT Analysis.">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MAST</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.7.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MAITAnalysis.html">Using MAST with RNASeq: MAIT Analysis.</a>
    </li>
    <li>
      <a href="../articles/MAST-Intro.html">MAST Intro</a>
    </li>
    <li>
      <a href="../articles/MAST-interoperability.html">Interoptability between MAST and SingleCellExperiment-derived packages.</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/RGLab/MAST/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using MAST with RNASeq: MAIT Analysis.</h1>
                        <h4 class="author">Greg Finak</h4>
                        <h4 class="author">Andrew McDavid</h4>
                        <h4 class="author">Masanao Yajima</h4>
                        <h4 class="author">Jingyuan Deng</h4>
                        <h4 class="author">Vivian Gersuk</h4>
                        <h4 class="author">Alex Shalek</h4>
                        <h4 class="author">Chloe K. Schlicter</h4>
                        <h4 class="author">Hannah W. Miller</h4>
                        <h4 class="author">M. Juliana McElrath</h4>
                        <h4 class="author">Martin Prlic</h4>
                        <h4 class="author">Peter Linsley</h4>
                        <h4 class="author">Raphael Gottardo</h4>
            
            <h4 class="date">2018-10-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/RGLab/MAST//blob/master/vignettes/MAITAnalysis.Rmd"><code>vignettes/MAITAnalysis.Rmd</code></a></small>
      <div class="hidden name"><code>MAITAnalysis.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>We will learn how to use the package <a href="http://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0844-5">MAST</a> to analyze single cell RNAseq experiments.</p>
<p>Starting from a matrix of counts of transcripts (cells by transcripts), we will discuss the preliminary steps of quality control, filtering, and exploratory data analysis. Once we are satisfied that we have high-quality expression, we will consider tests for differential expression and ways to visualize results. It is often helpful to synthesize from gene-level into module-level statements. Therefore, we will learn how to use MAST to test for gene set enrichment.</p>
<p>We will apply these methods to a data set of Mucosal Associated Invariant T cells (MAITs), measured on the Fluidigm C1. Half of the cells have been cytokine stimulated.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">suppressPackageStartupMessages</span>({</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">    <span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="kw">library</span>(GGally)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="kw">library</span>(GSEABase)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="kw">library</span>(limma)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="kw">library</span>(reshape2)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="kw">library</span>(data.table)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="kw">library</span>(TxDb.Hsapiens.UCSC.hg19.knownGene)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">    <span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="kw">library</span>(NMF)</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="kw">library</span>(rsvd)</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">    <span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    <span class="kw">library</span>(MAST)</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">})</a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#options(mc.cores = detectCores() - 1) #if you have multiple cores to spin</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="kw">options</span>(<span class="dt">mc.cores =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb1-18" data-line-number="18">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/assign">set</a></span>(<span class="dt">message =</span> <span class="ot">FALSE</span>,<span class="dt">error =</span> <span class="ot">FALSE</span>,<span class="dt">warning =</span> <span class="ot">FALSE</span>,<span class="dt">cache =</span> <span class="ot">FALSE</span>,<span class="dt">fig.width=</span><span class="dv">8</span>,<span class="dt">fig.height=</span><span class="dv">6</span>, <span class="dt">auto.dep=</span><span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="loading-and-transforming-data" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-and-transforming-data" class="anchor"></a>Loading and transforming data</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">freq_expressed &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">FCTHRESHOLD &lt;-<span class="st"> </span><span class="kw">log2</span>(<span class="fl">1.5</span>)</a></code></pre></div>
<p>First, let’s set some constants that we can use throughout this analysis.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">data</span>(maits, <span class="dt">package=</span><span class="st">'MAST'</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">dim</span>(maits<span class="op">$</span>expressionmat)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">head</span>(maits<span class="op">$</span>cdat)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">head</span>(maits<span class="op">$</span>fdat)</a></code></pre></div>
<p>Next, let’s load the data, which consists of a matrix of log2 + 1 transcripts per million (TPM), as output by RSEM. Internally, we use the packages <a href="https://github.com/RGLab/RNASeqPipelineR">RNASeqPipelineR</a> and <a href="https://github.com/RGLab/preProcessData">preprocessData</a> to facilitate aligning and quantitating the raw reads. This is an experiment on Mucosal Associated Invariant T-cells from a single healthy donor. A number of cells were subjected to reverse transcription and library prep immediately, while others were first stimulated for 24 hours with a cytokine cocktail.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">scaRaw &lt;-<span class="st"> </span><span class="kw"><a href="../reference/FromMatrix.html">FromMatrix</a></span>(<span class="kw">t</span>(maits<span class="op">$</span>expressionmat), maits<span class="op">$</span>cdat, maits<span class="op">$</span>fdat)</a></code></pre></div>
<p><code>FromMatrix</code> constructs an object from a matrix (genes <span class="math inline">\(\times\)</span> cells) of expression, a <code>data.frame</code> of cell-level covariance and a <code>data.frame</code> of feature-level covariates. In this case, there are 96 single cells measured over 16302 genes. We derive from the <code>SummarizedExperiment</code> class, which makes it easy for feature (row) and cell (column) metadata to come along for the ride. There is also a constructor, <code>FromFlatDF</code> for flattened data where measurements, and cell and feature covariates are intermingled.</p>
<div id="exploratory-data-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#exploratory-data-analysis" class="anchor"></a>Exploratory Data Analysis</h2>
<p>Let’s explore these data with a heatmap and some PCA.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/NMF/topics/aheatmap">aheatmap</a></span>(<span class="kw">assay</span>(scaRaw[<span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>,]), <span class="dt">labRow=</span><span class="st">''</span>, <span class="dt">annCol=</span><span class="kw">as.data.frame</span>(<span class="kw">colData</span>(scaRaw)[,<span class="kw">c</span>(<span class="st">'condition'</span>, <span class="st">'ourfilter'</span>)]), <span class="dt">distfun=</span><span class="st">'spearman'</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/heatmap-1.png" width="288"></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">set.seed</span>(<span class="dv">123</span>)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">plotPCA &lt;-<span class="st"> </span><span class="cf">function</span>(sca_obj){</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    projection &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/rsvd/topics/rpca">rpca</a></span>(<span class="kw">t</span>(<span class="kw">assay</span>(sca_obj)), <span class="dt">retx=</span><span class="ot">TRUE</span>, <span class="dt">k=</span><span class="dv">4</span>)<span class="op">$</span>x</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">    <span class="kw">colnames</span>(projection)=<span class="kw">c</span>(<span class="st">"PC1"</span>,<span class="st">"PC2"</span>,<span class="st">"PC3"</span>,<span class="st">"PC4"</span>)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    pca &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/data.table">data.table</a></span>(projection,  <span class="kw">as.data.frame</span>(<span class="kw">colData</span>(sca_obj)))</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="kw">print</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/GGally/topics/ggpairs">ggpairs</a></span>(pca, <span class="dt">columns=</span><span class="kw">c</span>(<span class="st">'PC1'</span>, <span class="st">'PC2'</span>, <span class="st">'PC3'</span>, <span class="st">'libSize'</span>, <span class="st">'PercentToHuman'</span>, <span class="st">'nGeneOn'</span>, <span class="st">'exonRate'</span>),</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">            <span class="dt">mapping=</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color=</span>condition), <span class="dt">upper=</span><span class="kw">list</span>(<span class="dt">continuous=</span><span class="st">'blank'</span>)))</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="kw">invisible</span>(pca)</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb6-10" data-line-number="10"></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="kw">plotPCA</span>(scaRaw)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/pca-1.png" width="288"></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">filterCrit &lt;-<span class="st"> </span><span class="kw">with</span>(<span class="kw">colData</span>(scaRaw), pastFastqc<span class="op">==</span><span class="st">"PASS"</span><span class="op">&amp;</span><span class="st"> </span>exonRate <span class="op">&gt;</span><span class="fl">0.3</span> <span class="op">&amp;</span><span class="st"> </span>PercentToHuman<span class="op">&gt;</span><span class="fl">0.6</span> <span class="op">&amp;</span><span class="st"> </span>nGeneOn<span class="op">&gt;</span><span class="st"> </span><span class="dv">4000</span>)</a></code></pre></div>
<p>From the PCA and heatmap we can tell that we’ve got some data quality issues with low-diversity libraries, and libraries where we capture a lot of non mRNA. We’ll set a filtering threshold using the <a href="https://en.wikipedia.org/wiki/I_know_it_when_I_see_it">Potter Stewart</a> method, though Shalek et al and others have come up with more principled ways, such as training SVM on the expression data and quality metrics to predict failed libraries. Though this still presupposes a set of labeled “failures” and “successes”.</p>
</div>
<div id="filtering" class="section level2">
<h2 class="hasAnchor">
<a href="#filtering" class="anchor"></a>Filtering</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">sca &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/subset.data.table">subset</a></span>(scaRaw,filterCrit)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">eid &lt;-<span class="st"> </span><span class="kw">select</span>(TxDb.Hsapiens.UCSC.hg19.knownGene,<span class="dt">keys =</span> <span class="kw">mcols</span>(sca)<span class="op">$</span>entrez,<span class="dt">keytype =</span><span class="st">"GENEID"</span>,<span class="dt">columns =</span> <span class="kw">c</span>(<span class="st">"GENEID"</span>,<span class="st">"TXNAME"</span>))</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">ueid &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/na.omit.data.table">na.omit</a></span>(eid)<span class="op">$</span>GENEID)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">sca &lt;-<span class="st"> </span>sca[<span class="kw">mcols</span>(sca)<span class="op">$</span>entrez <span class="op">%in%</span><span class="st"> </span>ueid,]</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">## Remove invariant genes</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">sca &lt;-<span class="st"> </span>sca[<span class="kw">sample</span>(<span class="kw">which</span>(<span class="kw"><a href="../reference/freq.html">freq</a></span>(sca)<span class="op">&gt;</span><span class="dv">0</span>), <span class="dv">6000</span>),]</a></code></pre></div>
<p>We’ll now consider only cells that pass the filter. <code><a href="http://www.rdocumentation.org/packages/data.table/topics/subset.data.table">subset(scaRaw, filterCrit)</a></code> is just syntactic sugar for subsetting by columns, but who doesn’t like a little sugar? We’ll also limit ourselves to transcripts that have an EntrezGene id to facilitate interpretation. Lastly, we will take a subsample of about 50% of the total genes to keep this vignette from taking too long or too much memory.</p>
<div id="recalculating-the-cellular-detection-rate-ngeneson" class="section level3">
<h3 class="hasAnchor">
<a href="#recalculating-the-cellular-detection-rate-ngeneson" class="anchor"></a>Recalculating the cellular detection rate (ngeneson)</h3>
<p>We and others have found that the number of genes detected in a sample, which we deemed the cellular detection rate is often the first principal component. After we removed genes low expression, perhaps we want to recalculate it.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">cdr2 &lt;-<span class="kw">colSums</span>(<span class="kw">assay</span>(sca)<span class="op">&gt;</span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/qplot">qplot</a></span>(<span class="dt">x=</span>cdr2, <span class="dt">y=</span><span class="kw">colData</span>(sca)<span class="op">$</span>nGeneOn) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">'New CDR'</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">'Old CDR'</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-1-1.png" width="384"></p>
<p>We can assign this to a new column in the <code>colData</code> in the obvious fashion:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">colData</span>(sca)<span class="op">$</span>cngeneson &lt;-<span class="st"> </span><span class="kw">scale</span>(cdr2)</a></code></pre></div>
</div>
<div id="pca-on-filtered-cells" class="section level3">
<h3 class="hasAnchor">
<a href="#pca-on-filtered-cells" class="anchor"></a>PCA on filtered cells</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">plotPCA</span>(sca)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/pcaFilter-1.png" width="288"> PC1 now primarily captures stimulation effects. We still observe that PC2 correlates with the exonRate and ngeneson, but the data are more smoothly distributed.</p>
</div>
<div id="exercises-on-loading-and-transforming-data" class="section level3">
<h3 class="hasAnchor">
<a href="#exercises-on-loading-and-transforming-data" class="anchor"></a>Exercises on loading and transforming data</h3>
<ol style="list-style-type: decimal">
<li>These samples were reverse-transcribed and amplified on two Fluidigm C1 chips (and stimulation is completely confounded with chip…) The chip location is contained in the column <code>wellKey</code> in <code>colData(sca)</code> as a three-character string like <code>CXX</code>. How could you extract the chip location and add it as column to the cellular data? Hint: <code>str_split_fixed</code> or <code>str_extract</code> may be your friends here.</li>
</ol>
</div>
</div>
</div>
<div id="adaptive-thresholding" class="section level1">
<h1 class="hasAnchor">
<a href="#adaptive-thresholding" class="anchor"></a>Adaptive thresholding</h1>
<p>Single cell gene expression data are known to be zero-inflated and bimodal, which is feature we observe here as well.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">scaSample &lt;-<span class="st"> </span>sca[<span class="kw">sample</span>(<span class="kw">which</span>(<span class="kw"><a href="../reference/freq.html">freq</a></span>(sca)<span class="op">&gt;</span>.<span class="dv">1</span>), <span class="dv">20</span>),]</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">flat &lt;-<span class="st"> </span><span class="kw">as</span>(scaSample, <span class="st">'data.table'</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(flat, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>value))<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>() <span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>symbolid, <span class="dt">scale=</span><span class="st">'free_y'</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/distribution-1.png" width="576"></p>
<p>Here we’ve taken subsample of size 20, then flattened it into a <code>data.table</code> to make it easy to plot with <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">thres &lt;-<span class="st"> </span><span class="kw"><a href="../reference/thresholdSCRNACountMatrix.html">thresholdSCRNACountMatrix</a></span>(<span class="kw">assay</span>(sca), <span class="dt">nbins =</span> <span class="dv">20</span>, <span class="dt">min_per_bin =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">4</span>))</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw">plot</span>(thres)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/threshold-1.png" width="576"></p>
<p>We suspect that the left-most mode corresponds to non-specific hybridization of mRNA or genomic DNA. Here we apply an adaptive scheme to threshold values below a cut-off that depends on the intensity of the signal cluster from the gene (determined from the median expression value). When we plot the threshold vs genes binned by median expression value, we can see this evolution of thresholding value.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">assays</span>(sca) &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">thresh=</span>thres<span class="op">$</span>counts_threshold, <span class="dt">tpm=</span><span class="kw">assay</span>(sca))</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">expressed_genes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/freq.html">freq</a></span>(sca) <span class="op">&gt;</span><span class="st"> </span>freq_expressed</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">sca &lt;-<span class="st"> </span>sca[expressed_genes,]</a></code></pre></div>
<p>We’ll limit ourselves to genes that are found in at least 0.2 of the sample (since we won’t have any power to conclude much about less frequent transcripts). We will also downsample to 1000 genes to keep this vignette from running too slowly.</p>
<div id="exercises-on-thresholding" class="section level3">
<h3 class="hasAnchor">
<a href="#exercises-on-thresholding" class="anchor"></a>Exercises on thresholding</h3>
<ol start="2" style="list-style-type: decimal">
<li>Many modeling procedures assume (or perform best) when the data are Normally distributed. How could we evaluate how thresholding affects the Normality of the data? How about the Normality of the non-zero data?</li>
</ol>
</div>
</div>
<div id="differential-expression-using-a-hurdle-model" class="section level1">
<h1 class="hasAnchor">
<a href="#differential-expression-using-a-hurdle-model" class="anchor"></a>Differential Expression using a Hurdle model</h1>
<p>We’ll fit a hurdle model, modeling the condition and (centered) <code>ngeneson</code> factor, thus adjusting for the cellular detection rate.</p>
<p>In order to have more interpretable coefficients, we’ll set the reference level of the factor to be the “unstimulated” cells.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">cond&lt;-<span class="kw">factor</span>(<span class="kw">colData</span>(sca)<span class="op">$</span>condition)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">cond&lt;-<span class="kw">relevel</span>(cond,<span class="st">"Unstim"</span>)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">colData</span>(sca)<span class="op">$</span>condition&lt;-cond</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">zlmCond &lt;-<span class="st"> </span><span class="kw"><a href="../reference/zlm.html">zlm</a></span>(<span class="op">~</span>condition <span class="op">+</span><span class="st"> </span>cngeneson, sca)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co"># The following are equivalent</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"><span class="co">## lrt &lt;- lrTest(zlm, "condition")</span></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="co">## lrt &lt;- lrTest(zlm, CoefficientHypothesis('conditionStim'))</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8"></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co"># This would test if 2*cngeneson=conditionStim</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10"><span class="co">#  This is sheer nonsense biologically and statistically, but gives an example of the flexibility.</span></a>
<a class="sourceLine" id="cb15-11" data-line-number="11"><span class="co">## lrt &lt;- lrTest(zlm, Hypothesis('2*cngeneson-conditionStim'))</span></a></code></pre></div>
<p>We could run a likelihood ratio test here, testing for differences when we drop the <code>condition</code> factor. Note that any arbitrary contrast matrix can be tested here, and specified either using a matrix or syntactically. See <code>Hypothesis</code> for details.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co">#only test the condition coefficient.</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2">summaryCond &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/NMF/topics/assess">summary</a></span>(zlmCond, <span class="dt">doLRT=</span><span class="st">'conditionStim'</span>) </a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="co">#print the top 4 genes by contrast using the logFC</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="kw">print</span>(summaryCond, <span class="dt">n=</span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>## Fitted zlm with top 4 genes per contrast:
## ( log fold change Z-score )
##  primerid conditionStim cngeneson
##  11264      -4.5           3.7*  
##  125061     -3.3           4.1*  
##  1327        1.1           3.6*  
##  1831       -6.5*          2.4   
##  1968        0.3           4.1*  
##  2353       -7.8*          0.4   
##  678        -6.3*         -0.8   
##  7296        6.2*          1.4</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co">## by discrete Z-score</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">print</span>(summaryCond, <span class="dt">n=</span><span class="dv">4</span>, <span class="dt">by=</span><span class="st">'D'</span>)</a></code></pre></div>
<pre><code>## Fitted zlm with top 4 genes per contrast:
## ( Wald Z-scores on discrete )
##  primerid  conditionStim cngeneson
##  100132356   -4.0*          2.2   
##  100506548   -2.6           4.2*  
##  134147      -4.0*          2.9   
##  163702      -3.4           4.5*  
##  23243       -2.2           4.2*  
##  29968        3.9*          0.1   
##  558         -4.0*          3.8   
##  6360        -3.2           4.6*</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="co">## by continuous Z-score</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw">print</span>(summaryCond, <span class="dt">n=</span><span class="dv">4</span>, <span class="dt">by=</span><span class="st">'C'</span>)</a></code></pre></div>
<pre><code>## Fitted zlm with top 4 genes per contrast:
## ( Wald Z-scores tests on continuous )
##  primerid conditionStim cngeneson
##  1652        3.2          -4.0*  
##  4818       -4.7*          2.2   
##  51188       1.5          -4.0*  
##  6164       -5.3*          0.8   
##  6232       -6.1*         -0.7   
##  6482        4.3*         -6.2*  
##  9459        3.1          -3.8*</code></pre>
<p>But often of more general use is this delicious syntactic sugar to make a giant <code>data.table</code> containing coefficients, standard errors, etc, for the various model components. Many Bothan spies died so that we could pretty-print this summary of the top differentially expressed genes.</p>
<p>Strip off the <code>$datatable</code> component to stop this pretty-printing (or call <code>print.default</code>.)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">summaryDt &lt;-<span class="st"> </span>summaryCond<span class="op">$</span>datatable</a>
<a class="sourceLine" id="cb22-2" data-line-number="2">fcHurdle &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(summaryDt[contrast<span class="op">==</span><span class="st">'conditionStim'</span> <span class="op">&amp;</span><span class="st"> </span>component<span class="op">==</span><span class="st">'H'</span>,.(primerid, <span class="st">`</span><span class="dt">Pr(&gt;Chisq)</span><span class="st">`</span>)], <span class="co">#hurdle P values</span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3">                      summaryDt[contrast<span class="op">==</span><span class="st">'conditionStim'</span> <span class="op">&amp;</span><span class="st"> </span>component<span class="op">==</span><span class="st">'logFC'</span>, .(primerid, coef, ci.hi, ci.lo)], <span class="dt">by=</span><span class="st">'primerid'</span>) <span class="co">#logFC coefficients</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"></a>
<a class="sourceLine" id="cb22-5" data-line-number="5">fcHurdle[,fdr<span class="op">:</span><span class="er">=</span><span class="kw">p.adjust</span>(<span class="st">`</span><span class="dt">Pr(&gt;Chisq)</span><span class="st">`</span>, <span class="st">'fdr'</span>)]</a>
<a class="sourceLine" id="cb22-6" data-line-number="6">fcHurdleSig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(fcHurdle[fdr<span class="op">&lt;</span>.<span class="dv">05</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">abs</span>(coef)<span class="op">&gt;</span>FCTHRESHOLD], <span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw">mcols</span>(sca)), <span class="dt">by=</span><span class="st">'primerid'</span>)</a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/setorder">setorder</a></span>(fcHurdleSig, fdr)</a></code></pre></div>
<p>We see that there are 287 genes significant at a FDR of 5% and with a log-fold change larger than 0.6.</p>
<div id="visualization-of-50-most-differentially-expressed-genes" class="section level3">
<h3 class="hasAnchor">
<a href="#visualization-of-50-most-differentially-expressed-genes" class="anchor"></a>Visualization of 50 most differentially expressed genes</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">entrez_to_plot &lt;-<span class="st"> </span>fcHurdleSig[<span class="dv">1</span><span class="op">:</span><span class="dv">50</span>,primerid]</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">symbols_to_plot &lt;-<span class="st"> </span>fcHurdleSig[<span class="dv">1</span><span class="op">:</span><span class="dv">50</span>,symbolid]</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">flat_dat &lt;-<span class="st"> </span><span class="kw">as</span>(sca[entrez_to_plot,], <span class="st">'data.table'</span>)</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">ggbase &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(flat_dat, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>condition, <span class="dt">y=</span>thresh,<span class="dt">color=</span>condition)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_jitter">geom_jitter</a></span>()<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>symbolid, <span class="dt">scale=</span><span class="st">'free_y'</span>)<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"DE Genes in Activated MAIT Cells"</span>)</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">ggbase<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_violin">geom_violin</a></span>() </a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-4-1.png" width="288"> Here is a standard violin plot showing how expression differs in each gene between stimulated and unstimulated cells. What could be improved about this visualization to make it more accurately reflect the model that’s being fit?</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">flat_dat[,lmPred<span class="op">:</span><span class="er">=</span><span class="kw">lm</span>(thresh<span class="op">~</span>cngeneson <span class="op">+</span><span class="st"> </span>condition)<span class="op">$</span>fitted, key=symbolid]</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">ggbase <span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>cngeneson) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">y=</span>lmPred), <span class="dt">lty=</span><span class="dv">1</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">'Standardized Cellular Detection Rate'</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-5-1.png" width="288"> Really we are doing an analysis of covariance (ANCOVA), where we ask if at each value of <code>cngeneson</code> if the stimulated cells differ from the unstimulated, in multiple module components. That is a little bit complicated to visualize, so we’ll settle for just showing what the ANCOVA looks like on the zero-inflated data. Adding these fitted values is easy with <code>data.table</code> on the melted data.</p>
</div>
<div id="visualizing-both-components" class="section level3">
<h3 class="hasAnchor">
<a href="#visualizing-both-components" class="anchor"></a>Visualizing both components</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="co">## This is all rather kludgy at the moment</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2">MM &lt;-<span class="st"> </span><span class="kw"><a href="../reference/model.matrix.html">model.matrix</a></span>(<span class="op">~</span>condition,<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(<span class="kw">colData</span>(sca)[,<span class="kw">c</span>(<span class="st">"condition"</span>),<span class="dt">drop=</span><span class="ot">FALSE</span>]))</a>
<a class="sourceLine" id="cb25-3" data-line-number="3"><span class="kw">rownames</span>(MM) &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_extract">str_extract</a></span>(<span class="kw">rownames</span>(MM), <span class="st">'Stim|Unstim'</span>)</a>
<a class="sourceLine" id="cb25-4" data-line-number="4">predicted &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/NMF/topics/predict">predict</a></span>(zlmCond,<span class="dt">modelmatrix=</span>MM)</a>
<a class="sourceLine" id="cb25-5" data-line-number="5"></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="co">## Avert your eyes...</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7">predicted[, primerid<span class="op">:</span><span class="er">=</span><span class="kw">as.character</span>(primerid)]</a>
<a class="sourceLine" id="cb25-8" data-line-number="8">predicted_sig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(<span class="kw">mcols</span>(sca), predicted[primerid<span class="op">%in%</span>entrez_to_plot], <span class="dt">by=</span><span class="st">'primerid'</span>)</a>
<a class="sourceLine" id="cb25-9" data-line-number="9">predicted_sig &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(predicted_sig)</a>
<a class="sourceLine" id="cb25-10" data-line-number="10"></a>
<a class="sourceLine" id="cb25-11" data-line-number="11"><span class="co">## plot with inverse logit transformed x-axis</span></a>
<a class="sourceLine" id="cb25-12" data-line-number="12"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(predicted_sig)<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span><span class="kw"><a href="../reference/invlogit.html">invlogit</a></span>(etaD),<span class="dt">y=</span>muC,<span class="dt">xse=</span>seD,<span class="dt">yse=</span>seC,<span class="dt">col=</span>sample)<span class="op">+</span></a>
<a class="sourceLine" id="cb25-13" data-line-number="13"><span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>symbolid,<span class="dt">scales=</span><span class="st">"free_y"</span>)<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_linedraw</a></span>()<span class="op">+</span></a>
<a class="sourceLine" id="cb25-14" data-line-number="14"><span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="dt">size=</span><span class="fl">0.5</span>)<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_x_continuous</a></span>(<span class="st">"Proportion expression"</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb25-15" data-line-number="15"><span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_continuous</a></span>(<span class="st">"Estimated Mean"</span>)<span class="op">+</span></a>
<a class="sourceLine" id="cb25-16" data-line-number="16"><span class="st">    </span><span class="kw"><a href="../reference/stat_ell.html">stat_ell</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>etaD,<span class="dt">y=</span>muC),<span class="dt">level=</span><span class="fl">0.95</span>, <span class="dt">invert=</span><span class="st">'x'</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-6-1.png" width="288"> Lastly, we can visualize how each component of the hurdle model is combined to yield a differential test by plotting the estimated coefficients (and standard errors) as a scatter plot. These confidence ellipses are drawn based on the <span class="math inline">\(\chi^2_2\)</span> distribution on the simultaneous test that either coefficient differs from zero. What do you notice about the relationship between the confidence interval on the proportion (x) and mean (y)?</p>
</div>
<div id="heatmap-of-maits-based-on-most-differentially-expressed-genes" class="section level2">
<h2 class="hasAnchor">
<a href="#heatmap-of-maits-based-on-most-differentially-expressed-genes" class="anchor"></a>Heatmap of MAITs based on most differentially expressed genes</h2>
<p>Here’s what the 50 most significantly differentially expressed(DE) genes look like.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">mat_to_plot &lt;-<span class="st"> </span><span class="kw">assay</span>(sca[entrez_to_plot,])</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="kw">rownames</span>(mat_to_plot) &lt;-<span class="st"> </span>symbols_to_plot</a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/NMF/topics/aheatmap">aheatmap</a></span>(mat_to_plot,<span class="dt">annCol=</span><span class="kw">colData</span>(sca)[,<span class="st">"condition"</span>],<span class="dt">main=</span><span class="st">"DE genes"</span>,<span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">colorRampPalette</span>(<span class="dt">colors =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dt">name=</span><span class="st">"PiYG"</span>,<span class="dt">n=</span><span class="dv">10</span>))(<span class="dv">20</span>)))</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="768"> Some of the activated MAITs have transcriptional profiles more similar to unactivated MAITS.</p>
<div id="exercises-on-hurdle-model-differential-expression" class="section level3">
<h3 class="hasAnchor">
<a href="#exercises-on-hurdle-model-differential-expression" class="anchor"></a>Exercises on hurdle model differential expression</h3>
<ol start="3" style="list-style-type: decimal">
<li>In some of the libraries it was possible to recover portions of the T-cell receptor alpha and beta chains from the reads. Behold, we live a golden age:</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">table</span>(<span class="kw">colData</span>(sca)<span class="op">$</span>beta, <span class="dt">exclude=</span><span class="ot">NULL</span>)</a></code></pre></div>
<pre><code>## 
##  other TRBV20  TRBV4  TRBV6   &lt;NA&gt; 
##      9      5      4     18     37</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="co">#Note that we currently throw an uninformative error if a covariate is `NA`</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2">scaHasBeta &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/subset.data.table">subset</a></span>(sca, <span class="op">!</span><span class="kw">is.na</span>(beta))</a></code></pre></div>
<p>How could you test for differential expression between TCR <code>beta</code> subtypes among <code>scaHasBeta</code>, the cells in which the TCR was successfully inferred? What is worrying about this procedure?</p>
</div>
</div>
<div id="residuals" class="section level2">
<h2 class="hasAnchor">
<a href="#residuals" class="anchor"></a>Residuals</h2>
<p>In the MAST paper, we assessed this further by examining a <em>residual</em> from the Hurdle linear model. This is not an entirely well-defined concept, as there are really two residuals in the Hurdle model, and there are multiple forms of residual that one can consider in logistic regression. Nonetheless, it can be a useful diagnostic. You can get a form of <a href="https://en.wikipedia.org/wiki/Deviance_(statistics)">deviance residual</a> by supplying a “hook” function to be called after each regression.</p>
<p>For example, in the subset of differentially expressed genes, we can refit the model and pull out the residual.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">scaDE &lt;-<span class="st"> </span>sca[entrez_to_plot,]</a>
<a class="sourceLine" id="cb30-2" data-line-number="2">zlmResidDE &lt;-<span class="st"> </span><span class="kw"><a href="../reference/zlm.html">zlm</a></span>(<span class="op">~</span>condition <span class="op">+</span><span class="st"> </span>cngeneson, scaDE, <span class="dt">hook=</span>deviance_residuals_hook)</a>
<a class="sourceLine" id="cb30-3" data-line-number="3">residDE &lt;-<span class="st"> </span>zlmResidDE<span class="op">@</span>hookOut</a>
<a class="sourceLine" id="cb30-4" data-line-number="4">residDEMatrix &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, residDE)</a></code></pre></div>
<p>The <code>residDE</code> was a list of residuals (one per gene in <code>scaDE</code>). We concatenated them into a matrix.</p>
<p>Now we can add <code>residDEMatrix</code> as another component of the “assay”:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">assays</span>(scaDE) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">assays</span>(scaDE), <span class="kw">list</span>(<span class="dt">resid=</span>residDEMatrix))</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">scaResidFlat &lt;-<span class="st"> </span><span class="kw">as</span>(scaDE, <span class="st">'data.table'</span>)</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">scaResidFlat[<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>,]</a></code></pre></div>
<pre><code>##    primerid entrez symbolid             wellKey condition nGeneOn  libSize
## 1:   134147 134147     CMBL 1-MAIT-Stim-C05_S91      Stim    8805 10055037
## 2:     1831   1831  TSC22D3 1-MAIT-Stim-C05_S91      Stim    8805 10055037
## 3:      558    558      AXL 1-MAIT-Stim-C05_S91      Stim    8805 10055037
## 4:     6232   6232    RPS27 1-MAIT-Stim-C05_S91      Stim    8805 10055037
##    PercentToHuman MedianCVCoverage PCRDuplicate exonRate pastFastqc ncells
## 1:          0.896          0.93833     0.756202    0.651       PASS      1
## 2:          0.896          0.93833     0.756202    0.651       PASS      1
## 3:          0.896          0.93833     0.756202    0.651       PASS      1
## 4:          0.896          0.93833     0.756202    0.651       PASS      1
##     ngeneson cngeneson    TRAV1 TRBV6 TRBV4 TRBV20 alpha beta         ac
## 1: 0.2764538 0.8847385 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim
## 2: 0.2764538 0.8847385 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim
## 3: 0.2764538 0.8847385 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim
## 4: 0.2764538 0.8847385 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim
##      bc ourfilter    thresh        tpm      resid
## 1: &lt;NA&gt;      TRUE  1.526069  1.5260688  0.7553895
## 2: &lt;NA&gt;      TRUE  0.000000  0.6415460 -0.5326753
## 3: &lt;NA&gt;      TRUE  0.000000  0.9259994 -1.7369755
## 4: &lt;NA&gt;      TRUE 11.416877 11.4168767 -0.5908884</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(scaResidFlat, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>ngeneson, <span class="dt">y=</span>resid))<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">col=</span>condition))<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_smooth">geom_smooth</a></span>()<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>symbolid)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/addResiduals-1.png" width="288"> This allows us, for example, to evaluate model diagnostics such as this “residuals vs variable” plot to check the linearity assumption of “ngeneson”. One can also conduct PCA or examine the correlation matrix to look for co-expressing modules of genes.</p>
</div>
</div>
<div id="gene-set-enrichment-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#gene-set-enrichment-analysis" class="anchor"></a>Gene Set Enrichment Analysis</h1>
<p>We use a competitive gene set enrichment test, in which a contrast (hurdle model coefficient) from various gene sets of interest is compared to the background, accounting for the intergene correlation of the module coefficient.</p>
<p>To estimate the intergene correlation of the contrast, we use bootstrapping. Cells (columns in <code>sca</code>) are sampled with replacement a number of times and we refit the model. At some point, we may implement a GEE-like method to estimate the intergene correlation through asymptotic calculations. But in the meantime, the bootstrapping can be slow, although is pleasingly parallelizable. To avoid setting the server farm alight, we will work with only a subset of the genes, and only calculate 5 bootstrap replicates. This would be completely inadequate if you wanted to report these results.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># bootstrap, resampling cells</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="co"># R should be set to &gt;50 if you were doing this for real.</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3">boots &lt;-<span class="st"> </span><span class="kw"><a href="../reference/bootVcov1.html">bootVcov1</a></span>(zlmCond, <span class="dt">R =</span> <span class="dv">4</span>)</a></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">module &lt;-<span class="st"> "BTM"</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">min_gene_in_module &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb35-3" data-line-number="3">packageExt &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="dt">package=</span><span class="st">'MAST'</span>)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">module_file &lt;-<span class="st"> </span><span class="kw">list.files</span>(packageExt, <span class="dt">pattern =</span> module, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">gene_set &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/GSEABase/topics/getObjects">getGmt</a></span>(module_file)</a>
<a class="sourceLine" id="cb35-6" data-line-number="6">gene_ids &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/GSEABase/topics/GeneSet-class">geneIds</a></span>(gene_set)</a>
<a class="sourceLine" id="cb35-7" data-line-number="7">gene_ids &lt;-<span class="st"> </span>gene_ids[<span class="op">!</span><span class="kw">names</span>(gene_ids)<span class="op">%like%</span><span class="st">"TBA"</span><span class="op">&amp;!</span><span class="kw">names</span>(gene_ids)<span class="op">%like%</span><span class="st">"B cell"</span>]</a>
<a class="sourceLine" id="cb35-8" data-line-number="8">sets_indices &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/limma/topics/ids2indices">ids2indices</a></span>(gene_ids, <span class="kw">mcols</span>(sca)<span class="op">$</span>symbolid)</a>
<a class="sourceLine" id="cb35-9" data-line-number="9"><span class="co"># Only keep modules with at least min_gene_in_module</span></a>
<a class="sourceLine" id="cb35-10" data-line-number="10">sets_indices &lt;-<span class="st"> </span>sets_indices[<span class="kw">sapply</span>(sets_indices, length) <span class="op">&gt;=</span><span class="st"> </span>min_gene_in_module]</a></code></pre></div>
<p>We will use the Blood Transcriptional Modules of <a href="www.nature.com/ni/journal/v15/n2/full/ni.2789.html">Li, et al</a> and select named modules not relating to B-cell functionality.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">gsea &lt;-<span class="st"> </span><span class="kw"><a href="../reference/gseaAfterBoot.html">gseaAfterBoot</a></span>(zlmCond, boots, sets_indices, <span class="kw"><a href="../reference/Hypothesis.html">CoefficientHypothesis</a></span>(<span class="st">"conditionStim"</span>)) </a>
<a class="sourceLine" id="cb36-2" data-line-number="2">z_stat_comb &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/NMF/topics/assess">summary</a></span>(gsea, <span class="dt">testType=</span><span class="st">'normal'</span>)</a></code></pre></div>
<p>The <code>summary</code> method returns a <code>data.table</code> with columns giving discrete and continuous Z-scores (<code>disc_Z</code> and <code>cont_Z</code>) and P-values testing if the average coefficient in the gene set differs from the average coefficient outside the set. A combined P-value (using Stouffer’s method) is given in column <code>combined_P</code>. The effect sizes (difference in average regression coefficients) is given in <code>effect_disc</code> and <code>effect_cont</code>. For the discrete component this gives, for example, the difference in the average odds of expression in the set vs outside the set.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1">sigModules &lt;-<span class="st"> </span>z_stat_comb[combined_adj<span class="op">&lt;</span>.<span class="dv">01</span>]</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">gseaTable &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/reshape2/topics/melt">melt</a></span>(sigModules[,.(set, disc_Z, cont_Z, combined_Z)], <span class="dt">id.vars=</span><span class="st">'set'</span>)</a>
<a class="sourceLine" id="cb37-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(gseaTable, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">y=</span>set, <span class="dt">x=</span>variable, <span class="dt">fill=</span>value))<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_raster</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_brewer">scale_fill_distiller</a></span>(<span class="dt">palette=</span><span class="st">"PiYG"</span>)</a></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/gseaView-1.png" width="768"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li>
<a href="#loading-and-transforming-data">Loading and transforming data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
      <li><a href="#filtering">Filtering</a></li>
      </ul>
</li>
      <li><a href="#adaptive-thresholding">Adaptive thresholding</a></li>
      <li>
<a href="#differential-expression-using-a-hurdle-model">Differential Expression using a Hurdle model</a><ul class="nav nav-pills nav-stacked">
<li><a href="#heatmap-of-maits-based-on-most-differentially-expressed-genes">Heatmap of MAITs based on most differentially expressed genes</a></li>
      <li><a href="#residuals">Residuals</a></li>
      </ul>
</li>
      <li><a href="#gene-set-enrichment-analysis">Gene Set Enrichment Analysis</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andrew McDavid, Greg Finak, Masanao Yajima.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
